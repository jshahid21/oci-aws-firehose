#cloud-config
# OCI-to-AWS Sync - Cloud-Init
# OCI kills cloud-init after ~2min; package install + runcmd exceed that.
# All setup runs in a background script so cloud-init completes immediately.

# Security: disable root login, no password auth
ssh_pwauth: false
disable_root: true

package_update: false
package_upgrade: false
# No packages: here - dnf install in background script to avoid OCI SIGTERM timeout

write_files:
  - path: /root/.config/rclone/rclone.conf
    owner: root:root
    permissions: "0600"
    content: |
      [oci_usage]
      type = oracleobjectstorage
      provider = user_principal_auth
      config_file = /root/.oci/config
      config_profile = rclone
      namespace = bling
      compartment = ${tenancy_ocid}
      region = ${region}

      [aws_s3]
      type = s3
      provider = AWS
      region = ${aws_region}
      env_auth = true

  - path: /usr/local/bin/sync.sh
    owner: root:root
    permissions: "0755"
    content: |
      #!/bin/bash
      set -e
      export PATH="/usr/local/bin:$PATH"
      export RCLONE_CONFIG="/root/.config/rclone/rclone.conf"
      export OCI_CLI_AUTH=instance_principal

      OCI_BIN="$(command -v oci 2>/dev/null)"
      [[ -z "$${OCI_BIN}" ]] && OCI_BIN="/usr/local/bin/oci"
%{ if aws_credentials_injected ~}
      export AWS_ACCESS_KEY_ID=$(echo '${aws_access_key_b64}' | base64 -d)
      export AWS_SECRET_ACCESS_KEY=$(echo '${aws_secret_key_b64}' | base64 -d)
%{ else ~}
      export AWS_ACCESS_KEY_ID=$($${OCI_BIN} --auth instance_principal secrets secret-bundle get --secret-id ${aws_access_key_secret_id} --query 'data.secret-bundle-content.content' --raw-output 2>/dev/null | base64 -d)
      export AWS_SECRET_ACCESS_KEY=$($${OCI_BIN} --auth instance_principal secrets secret-bundle get --secret-id ${aws_secret_key_secret_id} --query 'data.secret-bundle-content.content' --raw-output 2>/dev/null | base64 -d)
%{ endif ~}

      # OCI API key: injected via cloud-init (when enabled) or fetched from Vault
      mkdir -p /root/.oci
%{ if oci_private_key_injected ~}
      echo '${oci_private_key_b64}' | base64 -d > /root/.oci/key.pem
%{ else ~}
      ERR_LOG="/var/log/rclone-sync-errors.log"
      $${OCI_BIN} --auth instance_principal secrets secret-bundle get --secret-id ${oci_private_key_secret_id} --query 'data.secret-bundle-content.content' --raw-output 2>>"$${ERR_LOG}" | base64 -d > /root/.oci/key.pem
      if ! grep -q "BEGIN PRIVATE KEY" /root/.oci/key.pem 2>/dev/null; then
        echo "ERROR: Vault fetch failed - key.pem empty or invalid (check $${ERR_LOG}). Instance principal needs 'read secret-bundles'." >> /var/log/rclone-sync.log
        if [ -n "${alert_topic_id}" ]; then
          $${OCI_BIN} ons message publish --topic-id "${alert_topic_id}" --body "Rclone: Vault secret fetch failed. Check /var/log/rclone-sync-errors.log and key.pem" 2>/dev/null || true
        fi
        exit 1
      fi
%{ endif ~}
      chmod 600 /root/.oci/key.pem
      printf '[rclone]\nuser = %s\nfingerprint = %s\ntenancy = %s\nregion = %s\nkey_file = /root/.oci/key.pem\n' \
        '${oci_user_ocid}' '${oci_api_key_fingerprint}' '${tenancy_ocid}' '${region}' > /root/.oci/config
      chmod 600 /root/.oci/config

      if ! /usr/local/bin/rclone sync oci_usage:${tenancy_ocid} aws_s3:${aws_s3_bucket_name}/${aws_s3_prefix} --log-file=/var/log/rclone-sync.log --checksum --s3-chunk-size 64M --s3-upload-concurrency 8 -v; then
        if [ -n "${alert_topic_id}" ]; then
          $${OCI_BIN} ons message publish --topic-id "${alert_topic_id}" --body "Rclone sync FAILED. Check /var/log/rclone-sync.log on $(hostname)" 2>/dev/null || true
        fi
        exit 1
      fi

  - path: /usr/local/bin/bootstrap-oci-sync.sh
    owner: root:root
    permissions: "0755"
    content: |
      #!/bin/bash
      set -e
      exec > >(tee -a /var/log/cloud-init-bootstrap.log) 2>&1
      echo "=== OCI-to-AWS Sync Bootstrap started at $(date) ==="

      dnf install -y unzip jq
      dnf install -y python3-pip
      pip3 install --break-system-packages --no-cache-dir oci-cli 2>/dev/null || pip3 install --no-cache-dir oci-cli 2>/dev/null || true

      ARCH=$(uname -m)
      [[ "$${ARCH}" == "aarch64" ]] && RCLONE_ARCH=arm64 || RCLONE_ARCH=amd64
      curl -sLO "https://downloads.rclone.org/rclone-current-linux-$${RCLONE_ARCH}.zip"
      unzip -o rclone-current-linux-$${RCLONE_ARCH}.zip
      cp rclone-*-linux-$${RCLONE_ARCH}/rclone /usr/local/bin/
      chmod 755 /usr/local/bin/rclone

      if [ -n "${opc_password}" ]; then echo "opc:${opc_password}" | chpasswd; fi

      echo "0 */6 * * * root /usr/local/bin/sync.sh >> /var/log/rclone-sync.log 2>&1" >> /etc/crontab

      echo "=== Bootstrap complete at $(date), running first sync ==="
      /usr/local/bin/sync.sh || echo "First sync failed - check /var/log/rclone-sync.log"
      echo "=== Bootstrap finished at $(date) ==="

  - path: /etc/systemd/system/oci-sync-bootstrap.service
    owner: root:root
    permissions: "0644"
    content: |
      [Unit]
      Description=OCI Sync Bootstrap (delayed - avoids OOM during boot)
      After=network-online.target

      [Service]
      Type=oneshot
      ExecStartPre=/bin/sleep 90
      ExecStart=/usr/local/bin/bootstrap-oci-sync.sh
      RemainAfterExit=yes

      [Install]
      WantedBy=multi-user.target

runcmd:
  - systemctl enable oci-sync-bootstrap.service
  - ( systemctl start oci-sync-bootstrap.service & )
